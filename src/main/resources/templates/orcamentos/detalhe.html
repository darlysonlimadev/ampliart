<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragmentos/layout :: layout(~{::section})}">
    <section>
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-semibold">Orcamento <span th:text="${orcamento.id}"></span></h1>
            <a class="px-4 py-2 rounded bg-slate-900 text-white" th:href="@{/orcamentos/{id}/pdf(id=${orcamento.id})}">Exportar PDF</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white shadow rounded p-4 space-y-2">
                <div><strong>Cliente:</strong> <span th:text="${orcamento.clienteNome}"></span></div>
                <div><strong>Telefone:</strong> <span th:text="${orcamento.clienteTelefone}"></span></div>
                <div><strong>Email:</strong> <span th:text="${orcamento.clienteEmail}"></span></div>
                <div><strong>Status:</strong> <span th:text="${orcamento.status}"></span></div>
            </div>
            <div class="bg-white shadow rounded p-4">
                <form class="space-y-2" th:action="@{/orcamentos/{id}/status(id=${orcamento.id})}" method="post">
                    <label class="block text-sm font-medium">Alterar status</label>
                    <select class="border rounded px-3 py-2 w-full" name="novoStatus">
                        <option th:each="status : ${statusPossiveis}" th:value="${status}" th:text="${status}" th:selected="${orcamento.status == status}"></option>
                    </select>
                    <button class="px-4 py-2 rounded bg-slate-700 text-white" type="submit">Atualizar</button>
                </form>
            </div>
        </div>

        <div class="bg-white shadow rounded p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Adicionar item por codigo</h2>
            <form class="flex flex-col md:flex-row gap-3" th:action="@{/orcamentos/{id}/itens/adicionar(id=${orcamento.id})}" method="post">
                <input id="codigoProduto" class="border rounded px-3 py-2 flex-1" type="text" name="codigoProduto" placeholder="Bipar codigo de barras" autofocus />
                <input class="border rounded px-3 py-2 w-32" type="number" name="quantidade" value="1" min="1" />
                <button class="px-4 py-2 rounded bg-slate-900 text-white" type="submit">Adicionar</button>
            </form>
            <p class="text-sm text-slate-600 mt-2">Use o leitor de codigo de barras e pressione Enter para adicionar.</p>
        </div>

        <div class="bg-white shadow rounded p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Buscar produto por nome ou categoria</h2>
            <form class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4" method="get" th:action="@{/orcamentos/{id}(id=${orcamento.id})}">
                <input class="border rounded px-3 py-2" type="text" name="nomeProduto" placeholder="Nome do produto" th:value="${nomeProduto}" />
                <select class="border rounded px-3 py-2" name="categoriaId">
                    <option value="" th:selected="${categoriaId == null}">Todas categorias</option>
                    <option th:each="categoria : ${categorias}" th:value="${categoria.id}" th:text="${categoria.nome}" th:selected="${categoriaId == categoria.id}"></option>
                </select>
                <button class="px-4 py-2 rounded bg-slate-700 text-white" type="submit">Pesquisar</button>
            </form>
            <div class="overflow-auto">
                <table class="min-w-full">
                    <thead>
                    <tr class="text-left border-b">
                        <th class="p-3">Produto</th>
                        <th class="p-3">Categoria</th>
                        <th class="p-3">Preco venda</th>
                        <th class="p-3">Estoque</th>
                        <th class="p-3">Adicionar</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="produto : ${produtosDisponiveis}" class="border-b">
                        <td class="p-3" th:text="${produto.nome}"></td>
                        <td class="p-3" th:text="${produto.categoria != null ? produto.categoria.nome : '-'}"></td>
                        <td class="p-3" th:text="${produto.precoVenda}"></td>
                        <td class="p-3" th:text="${produto.quantidadeEstoque}"></td>
                        <td class="p-3">
                            <form th:action="@{/orcamentos/{id}/itens/adicionar-por-id(id=${orcamento.id})}" method="post" class="flex items-center gap-2">
                                <input type="hidden" name="produtoId" th:value="${produto.id}" />
                                <input class="border rounded px-2 py-1 w-20" type="number" name="quantidade" value="1" min="1" />
                                <button class="text-slate-900" type="submit">Adicionar</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white shadow rounded mb-6">
            <table class="min-w-full">
                <thead>
                <tr class="text-left border-b">
                    <th class="p-3">Produto</th>
                    <th class="p-3">Qtd</th>
                    <th class="p-3">Preco unit</th>
                    <th class="p-3">Subtotal</th>
                    <th class="p-3">Acoes</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${orcamento.itens}" class="border-b">
                    <td class="p-3" th:text="${item.produto.nome}"></td>
                    <td class="p-3">
                        <form th:action="@{/orcamentos/{id}/itens/{itemId}/atualizar(id=${orcamento.id}, itemId=${item.id})}" method="post" class="flex gap-2 items-center">
                            <input class="border rounded px-2 py-1 w-20" type="number" name="quantidade" th:value="${item.quantidade}" min="1" />
                            <input class="border rounded px-2 py-1 w-28 js-moeda" type="number" step="0.01" name="precoUnitario" th:value="${item.precoUnitario}" />
                            <button class="text-slate-900" type="submit">Salvar</button>
                        </form>
                    </td>
                    <td class="p-3" th:text="${item.precoUnitario}"></td>
                    <td class="p-3" th:text="${item.subtotal}"></td>
                    <td class="p-3">
                        <form th:action="@{/orcamentos/{id}/itens/{itemId}/remover(id=${orcamento.id}, itemId=${item.id})}" method="post">
                            <button class="text-rose-700" type="submit">Remover</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white shadow rounded p-4">
                <h2 class="text-lg font-semibold mb-3">Ajuste</h2>
                <form class="space-y-3" th:action="@{/orcamentos/{id}/ajuste(id=${orcamento.id})}" method="post">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="tipoAjuste" value="desconto" th:checked="${orcamento.tipoAjuste == T(com.ampliart.dominio.TipoAjuste).desconto}" />
                            Desconto
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="tipoAjuste" value="acrescimo" th:checked="${orcamento.tipoAjuste == T(com.ampliart.dominio.TipoAjuste).acrescimo}" />
                            Acrescimo
                        </label>
                    </div>
                    <input class="border rounded px-3 py-2 w-full" type="number" step="0.01" name="percentual" placeholder="Percentual" th:value="${orcamento.percentualAjuste}" />
                    <button class="px-4 py-2 rounded bg-slate-700 text-white" type="submit">Aplicar</button>
                </form>
            </div>
            <div class="bg-white shadow rounded p-4 space-y-2">
                <div><strong>Total bruto:</strong> <span th:text="${orcamento.totalBruto}"></span></div>
                <div><strong>Valor ajuste:</strong> <span th:text="${orcamento.valorAjuste}"></span></div>
                <div><strong>Total final:</strong> <span th:text="${orcamento.totalFinal}"></span></div>
                <div th:if="${orcamento.dataConclusao}"><strong>Concluido em:</strong> <span th:text="${orcamento.dataConclusao}"></span></div>
            </div>
        </div>

        <script>
            const campo = document.getElementById('codigoProduto');
            if (campo) {
                campo.focus();
            }
        </script>
    </section>
</html>
