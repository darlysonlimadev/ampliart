<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragmentos/layout :: layout(~{::section})}">
<section class="space-y-4">
    <div class="mx-auto max-w-[1200px] overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-900/90 dark:shadow-black/30">
        <div class="flex flex-col gap-4 border-b border-slate-200 px-4 py-4 dark:border-slate-700 sm:flex-row sm:items-start sm:justify-between sm:px-6 sm:py-5">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 dark:text-slate-100 md:text-5xl">Novo Orcamento</h1>
                <p class="mt-1 text-base text-slate-500 dark:text-slate-400 md:text-lg">Adicione produtos e defina o cliente</p>
            </div>
            <div class="flex items-center gap-2">
                <a class="inline-flex h-10 items-center rounded-lg bg-slate-100 px-4 text-sm font-semibold text-slate-600 transition hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700" th:href="@{/orcamentos/{id}/pdf(id=${orcamento.id})}">PDF</a>
                <a class="inline-flex h-10 w-10 items-center justify-center rounded-lg text-slate-400 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-500 dark:hover:bg-slate-800 dark:hover:text-slate-200" th:href="@{/orcamentos}">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path d="M6 6l12 12M18 6L6 18" stroke-linecap="round" />
                    </svg>
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-[1.05fr_minmax(0,0.95fr)]">
            <div class="border-r border-slate-200 p-4 dark:border-slate-700 sm:p-6">
                <form class="grid grid-cols-1 gap-3 md:grid-cols-[2fr_1fr_auto]" method="get" th:action="@{/orcamentos/{id}(id=${orcamento.id})}">
                    <input class="h-11 rounded-xl border border-slate-200 bg-white px-4 text-lg text-slate-700 outline-none transition focus:border-indigo-400 dark:border-slate-700 dark:bg-slate-950/60 dark:text-slate-100" type="text" name="nomeProduto" placeholder="Buscar por nome ou bipar codigo..." th:value="${nomeProduto}" autocomplete="off" autofocus />
                    <select class="h-11 rounded-xl border border-slate-200 bg-white px-3 text-base text-slate-600 outline-none transition focus:border-indigo-400 dark:border-slate-700 dark:bg-slate-950/60 dark:text-slate-100" name="categoriaId">
                        <option value="" th:selected="${categoriaId == null}">Todas categorias</option>
                        <option th:each="categoria : ${categorias}" th:value="${categoria.id}" th:text="${categoria.nome}" th:selected="${categoriaId == categoria.id}"></option>
                    </select>
                    <button class="h-11 rounded-xl bg-slate-800 px-4 text-base font-semibold text-white transition hover:bg-slate-700 dark:bg-indigo-600 dark:hover:bg-indigo-500" type="submit">Buscar</button>
                </form>

                <div class="mt-4 h-[420px] overflow-auto pr-1 sm:h-[560px]">
                    <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
                        <div th:each="produto : ${produtosDisponiveis}" class="rounded-xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800/80">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-2xl font-semibold leading-snug text-slate-800 dark:text-slate-100" th:text="${produto.nome}"></p>
                                    <p class="mt-1 text-lg text-slate-500 dark:text-slate-400">Estoque: <span th:text="${produto.quantidadeEstoque}"></span></p>
                                    <p class="text-3xl font-extrabold text-slate-800 dark:text-slate-100" th:text="'R$ ' + ${#numbers.formatDecimal(produto.precoVenda, 1, 2)}"></p>
                                </div>
                                <form class="flex items-center gap-2" th:action="@{/orcamentos/{id}/itens/adicionar-por-id(id=${orcamento.id})}" method="post">
                                    <input type="hidden" name="produtoId" th:value="${produto.id}" />
                                    <input class="h-9 w-14 rounded-lg border border-slate-200 bg-white px-2 text-center text-base dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" type="number" name="quantidade" value="1" min="1" />
                                    <button class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-slate-200 text-lg font-bold text-slate-700 transition hover:bg-indigo-600 hover:text-white dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-indigo-500" type="submit">+</button>
                                </form>
                            </div>
                        </div>
                        <div th:if="${#lists.isEmpty(produtosDisponiveis)}" class="rounded-xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center text-slate-500 dark:border-slate-700 dark:bg-slate-800/70 dark:text-slate-400 md:col-span-2">
                            Nenhum produto encontrado para os filtros informados.
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 sm:p-6">
                <p class="text-sm font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">Cliente</p>
                <p class="mt-2 border-b border-slate-200 pb-3 text-2xl font-semibold text-slate-700 dark:border-slate-700 dark:text-slate-100 md:text-4xl" th:text="${orcamento.clienteNome != null and !#strings.isEmpty(orcamento.clienteNome) ? orcamento.clienteNome : 'Nome do Cliente'}"></p>

                <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800/80">
                    <div th:if="${#lists.isEmpty(orcamento.itens)}" class="flex h-[290px] flex-col items-center justify-center text-slate-400 dark:text-slate-500">
                        <svg class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M3 3h2l2.6 10.3a1 1 0 0 0 1 .7h8.8a1 1 0 0 0 .98-.8L20 7H6" stroke-linecap="round" stroke-linejoin="round" />
                            <circle cx="10" cy="19" r="1.7" />
                            <circle cx="17" cy="19" r="1.7" />
                        </svg>
                        <p class="mt-3 text-lg md:text-2xl">Selecione produtos ao lado</p>
                    </div>

                    <div th:unless="${#lists.isEmpty(orcamento.itens)}" class="space-y-3">
                        <div class="max-h-[270px] space-y-2 overflow-auto pr-1">
                            <div th:each="item : ${orcamento.itens}" class="rounded-xl border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-900">
                                <p class="text-lg font-semibold text-slate-800 dark:text-slate-100" th:text="${item.produto.nome}"></p>
                                <form class="mt-2 grid grid-cols-1 items-center gap-2 sm:grid-cols-[70px_1fr_auto_auto]" th:action="@{/orcamentos/{id}/itens/{itemId}/atualizar(id=${orcamento.id}, itemId=${item.id})}" method="post">
                                    <input class="h-9 rounded-lg border border-slate-200 bg-white px-2 text-center dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" type="number" name="quantidade" min="1" th:value="${item.quantidade}" />
                                    <input class="js-moeda h-9 rounded-lg border border-slate-200 bg-white px-3 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" type="number" step="0.01" name="precoUnitario" th:value="${item.precoUnitario}" />
                                    <button class="h-9 rounded-lg bg-slate-200 px-3 text-sm font-semibold text-slate-700 transition hover:bg-indigo-600 hover:text-white dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-indigo-500" type="submit">Salvar</button>
                                    <span class="text-sm font-bold text-slate-700 dark:text-slate-200" th:text="'R$ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></span>
                                </form>
                                <form class="mt-2 text-right" th:action="@{/orcamentos/{id}/itens/{itemId}/remover(id=${orcamento.id}, itemId=${item.id})}" method="post">
                                    <button class="text-sm font-semibold text-rose-500 transition hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300" type="submit">Remover</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-5 rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-900">
                    <div class="flex items-center justify-between text-sm text-slate-500 dark:text-slate-400">
                        <span>Total bruto</span>
                        <span class="font-semibold text-slate-700 dark:text-slate-200" th:text="'R$ ' + ${#numbers.formatDecimal(orcamento.totalBruto, 1, 2)}"></span>
                    </div>
                    <div class="mt-2 flex items-center justify-between text-sm text-slate-500 dark:text-slate-400">
                        <span>
                            Ajuste
                            <span th:if="${orcamento.tipoAjuste != null and orcamento.percentualAjuste != null}"
                                  th:text="${'(' + (orcamento.tipoAjuste == T(com.ampliart.dominio.TipoAjuste).desconto ? '-' : '+') + #numbers.formatDecimal(orcamento.percentualAjuste, 1, 2) + '%)'}"></span>
                        </span>
                        <span class="font-semibold"
                              th:classappend="${orcamento.valorAjuste != null and orcamento.valorAjuste.signum() < 0} ? 'text-rose-600' : 'text-emerald-600'"
                              th:text="${orcamento.valorAjuste != null ? 'R$ ' + #numbers.formatDecimal(orcamento.valorAjuste, 1, 2) : 'R$ 0,00'}"></span>
                    </div>
                    <div class="mt-3 flex items-end justify-between border-t border-slate-200 pt-3 dark:border-slate-700">
                        <p class="text-2xl font-extrabold text-slate-800 dark:text-slate-100 md:text-4xl">Total:</p>
                        <p class="text-2xl font-extrabold text-slate-800 dark:text-slate-100 md:text-4xl" th:text="'R$ ' + ${#numbers.formatDecimal(orcamento.totalFinal, 1, 2)}"></p>
                    </div>
                </div>

                <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800/80">
                    <p class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Ajuste percentual</p>
                    <form class="mt-2 grid grid-cols-1 gap-2 sm:grid-cols-[1fr_130px_auto]" th:action="@{/orcamentos/{id}/ajuste(id=${orcamento.id})}" method="post">
                        <select class="h-11 rounded-xl border border-slate-200 bg-white px-3 text-base text-slate-700 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" name="tipoAjuste" required>
                            <option th:each="tipo : ${tiposAjuste}"
                                    th:value="${tipo}"
                                    th:text="${tipo == T(com.ampliart.dominio.TipoAjuste).desconto ? 'Desconto' : 'Acrescimo'}"
                                    th:selected="${orcamento.tipoAjuste == tipo}"></option>
                        </select>
                        <input class="h-11 rounded-xl border border-slate-200 bg-white px-3 text-base text-slate-700 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100"
                               type="number"
                               step="0.01"
                               min="0"
                               max="100"
                               name="percentual"
                               required
                               th:value="${orcamento.percentualAjuste != null ? orcamento.percentualAjuste : 0}" />
                        <button class="h-11 rounded-xl bg-slate-800 px-4 text-sm font-semibold text-white transition hover:bg-slate-700 dark:bg-indigo-600 dark:hover:bg-indigo-500" type="submit">Aplicar</button>
                    </form>
                    <form class="mt-2 text-right" th:action="@{/orcamentos/{id}/ajuste/remover(id=${orcamento.id})}" method="post">
                        <button class="text-sm font-semibold text-slate-500 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" type="submit">Remover ajuste</button>
                    </form>
                </div>

                <div class="mt-5 space-y-3">
                    <form th:action="@{/orcamentos/{id}/status(id=${orcamento.id})}" method="post">
                        <input type="hidden" name="novoStatus" value="enviado" />
                        <button class="flex h-12 w-full items-center justify-center gap-2 rounded-xl bg-indigo-600 text-base font-bold text-white shadow-lg shadow-indigo-900/20 transition hover:bg-indigo-500 dark:shadow-black/30 md:text-xl" type="submit">
                            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" aria-hidden="true">
                                <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            Gerar Orcamento
                        </button>
                    </form>

                    <form class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_auto]" th:action="@{/orcamentos/{id}/status(id=${orcamento.id})}" method="post">
                        <select class="h-11 rounded-xl border border-slate-200 bg-white px-3 text-base text-slate-600 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" name="novoStatus">
                            <option th:each="status : ${statusPossiveis}" th:value="${status.name()}" th:text="${status.label}" th:selected="${orcamento.status == status}"></option>
                        </select>
                        <button class="h-11 rounded-xl bg-slate-200 px-4 text-sm font-semibold text-slate-700 transition hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600" type="submit">Atualizar status</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
</html>
